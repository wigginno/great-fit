# Great Fit Infrastructure

This directory contains the **AWS CDK v2 (Python)** stack that provisions the AWS infrastructure for the Great Fit application.

It sets up:

*   A Virtual Private Cloud (VPC) with public, private, and isolated subnets.
*   An AWS RDS Aurora Serverless v2 PostgreSQL database cluster.
*   AWS Secrets Manager for storing database credentials securely.
*   An AWS ECR repository to store the application's Docker image.
*   An AWS App Runner service to run the containerized application, connected to the VPC.
*   References to AWS Cognito resources (User Pool ID, Client ID - *assumes Cognito is managed separately*).
*   Basic CloudWatch monitoring (Alarms, Dashboard) and an SNS topic for notifications.
*   Necessary IAM Roles and Security Groups.

---

## üöÄ Quick Start: Deploying the Stack

### Prerequisites

*   AWS Account and configured AWS CLI credentials.
*   Node.js and npm (for AWS CDK CLI).
*   Python 3.11+ and pip.
*   AWS CDK CLI installed (`npm install -g aws-cdk@2`).
*   An existing AWS ECR repository named `great-fit` (the CI/CD pipeline creates this if it doesn't exist, or you can create it manually).
*   Existing AWS Secrets Manager secrets for Cognito details (e.g., `greatfit/userpool/id`, `greatfit/userpool/arn`, `greatfit/userpool/clientid`) and the OpenRouter API key (default name: `OPENROUTER_API_KEY`). You can override the OpenRouter secret name via the `OPENROUTER_SECRET_NAME` environment variable during deployment.
*   (Optional) An email address set in the `ALERT_EMAIL` environment variable if you want CloudWatch alarm notifications.

### Deployment Steps

1.  **Navigate to the infra directory:**
    ```bash
    cd infra
    ```

2.  **Set up Python virtual environment and install dependencies:**
    ```bash
    python -m venv .venv
    source .venv/bin/activate  # On Windows: .venv\Scripts\activate
    pip install -r requirements.txt
    ```

3.  **Bootstrap CDK (only needs to be done once per AWS account/region):**
    ```bash
    cdk bootstrap aws://<YOUR_ACCOUNT_ID>/<YOUR_REGION>
    # Example: cdk bootstrap aws://123456789012/us-east-1
    ```

4.  **Deploy the stack:**
    *(Optional: Set environment variables like `ALERT_EMAIL` or `OPENROUTER_SECRET_NAME` if needed)*
    ```bash
    # Example with optional email alert
    # export ALERT_EMAIL="your-email@example.com"
    # export OPENROUTER_SECRET_NAME="my-openrouter-secret" # If different from default

    cdk deploy
    ```
    Confirm any security-related changes when prompted by the CDK CLI.

---

## üèó Stack Components

| Resource                     | Notes                                                                                                                            |
| :--------------------------- | :------------------------------------------------------------------------------------------------------------------------------- |
| **VPC**                      | 2 AZs, Public, Private (with NAT Gateway for egress), and Isolated subnets.                                                      |
| **RDS Cluster**              | Aurora PostgreSQL Serverless v2 (Engine 15.5), 0.5‚Äì2 ACUs, placed in Isolated subnets. Database name: `greatfit`.                 |
| **Secrets Manager**          | Autogenerated master password for DB user `gfadmin`. References existing secrets for OpenRouter API key and Cognito details.       |
| **ECR Repository**           | References the existing `great-fit` repository (must be created beforehand or by CI/CD).                                         |
| **App Runner Service**       | Runs the `latest` Docker image from the ECR repo. Configured with 1 vCPU, 2GB Memory. Uses VPC Connector for DB access.           |
| **VPC Connector**            | Allows App Runner to communicate with resources in the private subnets (specifically RDS). Placed in Private (egress) subnets.   |
| **Security Groups**          | `AppRunnerSG` allows App Runner egress and ingress from the RDS cluster on port 5432. RDS SG allows ingress from `AppRunnerSG`.    |
| **IAM Roles**                | `AppRunnerInstanceRole` allows App Runner tasks to read required secrets (DB, OpenRouter, Cognito) and interact with Cognito.    |
| **Cognito References**       | Reads User Pool ID, ARN, and Client ID from Secrets Manager to pass as environment variables/secrets to App Runner.                |
| **Observability Config**     | Configures App Runner to use AWS X-Ray for tracing.                                                                              |
| **CloudWatch Alarms/Dash**   | Basic alarm for high RDS CPU Utilization. Basic dashboard showing RDS CPU.                                                         |
| **SNS Topic**                | `AlarmTopic` for sending notifications when alarms are triggered (subscribes `ALERT_EMAIL` if provided).                           |

---

## ‚öôÔ∏è Configuration & Secrets

*   **Database Credentials:** The CDK stack creates a secret in Secrets Manager for the RDS master user (`gfadmin`) with an auto-generated password.
*   **OpenRouter API Key:** App Runner expects the OpenRouter API key to be stored in a secret named `OPENROUTER_API_KEY` (or the name specified by the `OPENROUTER_SECRET_NAME` env var during `cdk deploy`). The CDK stack grants App Runner's instance role permission to read this secret.
*   **Cognito Details:** App Runner needs the User Pool ID, ARN, and Client ID. The CDK stack expects these to be stored in secrets named `greatfit/userpool/id`, `greatfit/userpool/arn`, and `greatfit/userpool/clientid` respectively.
*   **App Runner Environment:** The CDK stack injects necessary environment variables and secrets into the App Runner service configuration:
    *   `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER` (plain text)
    *   `DB_PASSWORD` (from Secrets Manager)
    *   `OPENROUTER_API_KEY` (from Secrets Manager)
    *   `COGNITO_USER_POOL_ID`, `COGNITO_APP_CLIENT_ID` (from Secrets Manager)
    *   `AWS_REGION`

---

## üåê Networking: App Runner to RDS

1.  The RDS cluster instances are placed in the `PRIVATE_ISOLATED` subnets, which have no route to the internet or NAT Gateway.
2.  The App Runner service uses a **VPC Connector**, which places Elastic Network Interfaces (ENIs) into the `PRIVATE_WITH_EGRESS` subnets.
3.  A dedicated Security Group (`AppRunnerSG`) is attached to these ENIs.
4.  The RDS cluster's Security Group is configured to allow inbound traffic on port `5432` specifically from the `AppRunnerSG`.
5.  This allows the App Runner service to securely connect to the database within the VPC without exposing the database directly.

---

## üìä Monitoring

*   A CloudWatch Alarm (`GreatFit-RDS-HighCPU`) monitors the RDS cluster's CPU utilization. If it exceeds 80% for 3 consecutive minutes, it triggers an alert.
*   Alerts are sent to the SNS `AlarmTopic`. If the `ALERT_EMAIL` environment variable was set during `cdk deploy`, that email address will receive notifications.
*   A basic CloudWatch Dashboard (`GreatFit`) is created, showing the RDS CPU Utilization graph.
*   App Runner is configured for AWS X-Ray tracing.

---

## üõ† Outputs

After a successful `cdk deploy`, the following outputs are provided:

*   `DbEndpoint`: Hostname of the RDS cluster writer endpoint.
*   `DbSecretArn`: ARN of the Secrets Manager secret containing the database credentials (`{username, password}`).
*   `EcrRepoUri`: The full URI of the ECR repository.
*   `AppRunnerUrl`: The public HTTPS URL for the deployed App Runner service.
*   `UserPoolId`, `UserPoolClientId`, `CognitoDomainUrl`: Details referencing the Cognito configuration used.

You can construct the `DATABASE_URL` needed by the application (if not using individual `DB_*` vars) like this, retrieving the password from the secret:

```
postgresql://gfadmin:<password_from_secret>@<DbEndpoint>:5432/greatfit
```
