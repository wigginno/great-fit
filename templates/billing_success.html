<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Great Fit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Include Amplify JS (assuming it's needed for auth headers) -->
    <script src="https://cdn.amplify.aws/libs/aws-amplify/5.x.x/core/dist/aws-amplify-core.min.js"></script>
    <script src="https://cdn.amplify.aws/libs/aws-amplify/5.x.x/auth/dist/aws-amplify-auth.min.js"></script>
    <!-- Include your auth config and helper -->
    <script src="/static/js/auth-config.js"></script>
    <script src="/static/js/auth-helper.js"></script>
</head>
<body class="bg-gray-100 h-screen flex items-center justify-center" x-data="billingSuccess()">
    <div class="bg-white p-8 rounded-lg shadow-md text-center max-w-md">
        <h1 class="text-2xl font-bold text-green-600 mb-4">Payment Successful!</h1>
        <p class="text-gray-700 mb-6">Thank you for your purchase. Your credits should be updated shortly.</p>

        <div x-show="isLoading" class="mb-4">
            <p class="text-gray-600">Checking for updated credits...</p>
            <!-- Simple spinner -->
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto mt-4"></div>
        </div>

        <div x-show="errorMessage" class="mb-4 p-3 bg-red-100 text-red-700 rounded">
            <p x-text="errorMessage"></p>
        </div>

        <div x-show="!isLoading && !errorMessage">
             <p class="text-gray-700 mb-4">Your new balance is: <strong x-text="newCreditBalance">--</strong></p>
             <a href="/" class="inline-block bg-indigo-600 text-white font-semibold py-2 px-4 rounded hover:bg-indigo-700 transition duration-200">
                 Go to Dashboard
             </a>
        </div>

         <div x-show="showTimeoutMessage" class="mt-6 text-sm text-gray-500">
            <p>It's taking a bit longer than expected to update your credits. Please check your dashboard again in a few moments.</p>
             <a href="/" class="text-indigo-600 hover:underline">Go to Dashboard anyway</a>
        </div>
    </div>

    <script>
        const { Auth } = window.aws_amplify_auth; // Get Auth object

        function billingSuccess() {
            return {
                isLoading: true,
                newCreditBalance: null,
                errorMessage: '',
                showTimeoutMessage: false,
                maxAttempts: 10, // Poll for ~20 seconds (10 attempts * 2 seconds)
                pollInterval: 2000, // 2 seconds
                attempt: 0,
                async init() {
                    console.log('Billing success page init');
                    // Ensure Amplify is configured before trying to get session
                    if (window.configureAmplify) {
                        await window.configureAmplify();
                        console.log('Amplify configured on success page.');
                    } else {
                        console.error('configureAmplify function not found!');
                        this.errorMessage = 'Authentication setup error. Cannot verify credits.';
                        this.isLoading = false;
                        return;
                    }
                    // Need auth headers
                    try {
                        await Auth.currentSession(); // Check if user is logged in
                        this.pollForCredits();
                    } catch (e) {
                        console.error('Not authenticated on success page:', e);
                        this.errorMessage = 'You seem to be logged out. Please log in and check your credits on the dashboard.';
                        this.isLoading = false;
                        // Optionally redirect to login?
                        // window.location.href = '/';
                    }
                },
                async pollForCredits() {
                    if (this.attempt >= this.maxAttempts) {
                        console.warn('Polling timed out.');
                        this.errorMessage = 'Could not verify credit update in time.';
                        this.showTimeoutMessage = true;
                        this.isLoading = false;
                        return;
                    }

                    this.attempt++;
                    console.log(`Polling attempt ${this.attempt}/${this.maxAttempts}`);

                    try {
                        const response = await fetch('/users/me', { headers: await window.authHeaders() });
                        if (!response.ok) {
                            // Handle auth errors specifically
                            if (response.status === 401 || response.status === 403) {
                                console.error(`Authentication error (${response.status}) accessing /users/me. Redirecting to login.`);
                                // Can't use showToast directly here as it's not defined globally, set error message instead
                                this.errorMessage = 'Your session may have expired. Please sign in again.';
                                this.isLoading = false;
                                window.dispatchEvent(new CustomEvent('logoutSuccess')); // Update UI if needed
                                Auth.federatedSignIn(); // Redirect to login
                                return; // Stop polling
                            }
                            // Handle other HTTP errors
                            throw new Error(`Server error: ${response.status}`);
                        }
                        const userData = await response.json();
                        console.log('User data fetched:', userData);

                        // Check if credits have updated (assuming initial fetch happens fast)
                        // A better approach might be to fetch initial credits *before* polling starts
                        // or have the webhook signal the frontend via SSE.
                        // For now, we just check if it's > 10 (the default initial value).
                        // THIS IS A SIMPLISTIC CHECK - might be wrong if user had >10 credits before buying.
                        // A robust solution needs the pre-purchase balance or a webhook confirmation.
                        if (userData.credits > 10 || this.attempt > 1) { // Simple check: assumes credits increased or we made at least one attempt
                            this.newCreditBalance = userData.credits;
                            this.isLoading = false;
                            console.log('Credit update detected.');
                        } else {
                            // Credits not updated yet, poll again
                            setTimeout(() => this.pollForCredits(), this.pollInterval);
                        }
                    } catch (error) {
                        console.error('Error polling for credits:', error);
                        this.errorMessage = `Error checking credits: ${error.message}. Please check the dashboard manually.`;
                        this.isLoading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>
