{% extends "base.html" %}
{% block title %}Great Fit{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <nav class="bg-indigo-600">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="flex items-center">
          <a href="/" class="flex items-center text-white font-semibold text-lg">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" class="w-6 h-6 mr-2">
              <path d="M6.5 0a.5.5 0 0 0-.5.5V1H1.5A1.5 1.5 0 0 0 0 2.5V5h1v-.5A1.5 1.5 0 0 1 2.5 3H6v10H2.5A1.5 1.5 0 0 1 1 11.5V11H0v2.5A1.5 1.5 0 0 0 1.5 15H6v.5a.5.5 0 0 0 1 0V15h2v.5a.5.5 0 0 0 1 0V15h4.5A1.5 1.5 0 0 0 16 13.5V11h-1v.5a1.5 1.5 0 0 1-1.5 1.5H10V3h2.5A1.5 1.5 0 0 1 14 4.5V5h1V2.5A1.5 1.5 0 0 0 13.5 1H10V.5a.5.5 0 0 0-1 0V1H7V.5a.5.5 0 0 0-.5-.5z"/>
            </svg>
            Great&nbsp;Fit
          </a>
        </div>
        <div class="hidden md:block">
          <div class="ml-10 flex items-baseline space-x-4" id="authNav">
            <!-- Right‚Äëaligned nav items via htmx -->
          </div>
        </div>
        <!-- Credit Display & Purchase Button (shown when logged in) -->
        <div x-show="isLoggedIn" class="flex items-center space-x-4">
          <span class="text-sm text-gray-600">Credits: <span x-text="creditBalance">--</span></span>
          <button @click="buyCredits()" class="rounded-md bg-indigo-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">Buy Credits ($5)</button>
        </div>
      </div>
    </div>
  </nav>

  <main class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <div class="grid gap-8" id="mainGrid">
      <!-- User Profile -->
      <section class="rounded-lg bg-white p-6 shadow w-full mx-auto" id="resumeUploadSection">
        <div id="resumeUploadContainer">
          <div class="rounded-lg border-2 border-dashed border-indigo-400 bg-indigo-50 p-8 text-center transition-colors duration-200 ease-in-out hover:border-indigo-600 hover:bg-indigo-100 cursor-pointer" id="uploadArea" 
               :class="{ 'border-indigo-600 bg-indigo-100 ring-2 ring-indigo-300': isDraggingOver }">
            <input type="file" id="resumeFile" name="resume" accept=".pdf,.docx,.doc,.txt" class="hidden"/>
            <!-- Original Upload Content -->
            <div class="flex flex-col items-center space-y-4" id="uploadContent">
              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="h-12 w-12 text-indigo-600" viewBox="0 0 16 16">
                <path d="M.5 9.9v4.6c0 .3.2.5.5.5h3.8c.3 0 .5-.2.5-.5V12H8v2.5c0 .3.2.5.5.5h3.8c.3 0 .5-.2.5-.5V9.9h-1.2l-1.4 1.4V12h-2V7.7L9.9 6.5 8 4.6 6.1 6.5l1.4 1.2v4.3H5V11.3L3.6 9.9H.5zM7 1.5a.5.5 0 0 1 1 0V4h1a.5.5 0 0 1 0 1H6a.5.5 0 0 1 0-1h1V1.5z"/>
              </svg>
              <h4 class="text-lg font-medium text-gray-700">Drag & drop your resume</h4>
              <p class="text-sm text-gray-500">or click to browse</p>
              <p class="text-xs text-gray-400">Accepted: PDF, DOCX/DOC, TXT</p>
            </div>
            <!-- Loading Spinner (Initially Hidden) -->
            <div class="hidden flex-col items-center justify-center space-y-4" id="uploadSpinner">
              <svg class="h-12 w-12 animate-spin text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p class="text-lg font-medium text-gray-700">Processing...</p>
            </div>
          </div>
          <p class="mt-2 text-sm text-center text-gray-400" id="uploadStatus"></p>
        </div>
      </section>

      <!-- Profile Action Buttons (appear after profile generated) -->
      <div id="profileActions" class="hidden mb-4 flex space-x-4 justify-start">
        <button id="viewProfileButton" class="rounded bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">View&nbsp;Profile</button>
        <button id="resetProfileButton" class="rounded bg-gray-500 px-4 py-2 text-white hover:bg-gray-600">Re-upload&nbsp;Resume</button>
      </div>

      <!-- Saved Jobs -->
      <section class="rounded-lg bg-white p-6 shadow hidden" id="savedJobsSection">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-xl font-semibold">üíº Saved&nbsp;Jobs</h2>
          <button id="add-job-btn" class="rounded bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700">Add&nbsp;Job</button>
        </div>

        <div class="mb-2 hidden items-center space-x-2 rounded bg-blue-50 p-2 text-sm text-blue-800" id="savingIndicator">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" class="h-4 w-4 animate-spin">
            <path d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 1 .894-.448A4 4 0 1 0 8 4a.5.5 0 0 1 0-1z"/>
          </svg>
          <span id="savingIndicatorText" data-count="0">Processing&nbsp;0&nbsp;Job</span>
        </div>

        <div id="jobsList" class="space-y-4">
          <!-- Jobs will load here -->
          <p class="text-gray-400">Loading jobs...</p>
        </div>
        <div id="jobDetails" class="mt-6 rounded border bg-gray-50 p-4 text-gray-700 min-h-[100px]">
        </div>
      </section>
    </div>
  </main>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
    <div class="max-h-[90vh] w-full max-w-3xl overflow-y-auto rounded-lg bg-white p-6 shadow-lg flex flex-col">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-xl font-semibold">Your Profile</h3>
        <button id="closeProfileModal" class="text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" class="h-6 w-6">
            <path d="M.293 14.707a1 1 0 0 0 1.414 0L8 8.414l6.293 6.293a1 1 0 0 0 1.414-1.414L9.414 7 15.707.707a1 1 0 1 0-1.414-1.414L8 5.586 1.707-.707A1 1 0 0 0 .293.707L6.586 7 .293 13.293a1 1 0 0 0 0 1.414z"/>
          </svg>
        </button>
      </div>
      <div id="profileModalContent" class="text-sm text-gray-700"></div>
    </div>
  </div>

  <!-- Add Job Modal -->
  <div id="add-job-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
    <div class="max-h-[90vh] w-full max-w-xl overflow-y-auto rounded-lg bg-white p-6 shadow-lg flex flex-col">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-xl font-semibold">Add New Job</h3>
        <button class="close-btn text-gray-500 hover:text-gray-700">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" class="h-6 w-6">
            <path d="M.293 14.707a1 1 0 0 0 1.414 0L8 8.414l6.293 6.293a1 1 0 0 0 1.414-1.414L9.414 7 15.707.707a1 1 0 1 0-1.414-1.414L8 5.586 1.707-.707A1 1 0 0 0 .293.707L6.586 7 .293 13.293a1 1 0 0 0 0 1.414z"/>
          </svg>
        </button>
      </div>
      <div class="space-y-4">
        <div>
          <label for="modal-job-title" class="block text-sm font-medium text-gray-700">Job Title (optional)</label>
          <input id="modal-job-title" type="text" class="mt-1 w-full rounded border-gray-300" placeholder="Job Title"/>
        </div>
        <div>
          <label for="modal-job-company" class="block text-sm font-medium text-gray-700">Company (optional)</label>
          <input id="modal-job-company" type="text" class="mt-1 w-full rounded border-gray-300" placeholder="Company Name"/>
        </div>
        <div>
          <label for="modal-job-description" class="block text-sm font-medium text-gray-700">Job Description</label>
          <textarea id="modal-job-description" rows="6" class="mt-1 w-full rounded border-gray-300" placeholder="Paste full job posting here..."></textarea>
          <p class="mt-1 text-xs text-gray-500">We'll automatically clean up, format, and organize the info you paste from the job posting.</p>
        </div>
      </div>
      <div class="mt-6 flex justify-end space-x-3">
        <button id="modal-cancel-btn" class="rounded bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">Cancel</button>
        <button id="modal-save-btn" class="rounded bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">Save Job</button>
        <span id="modal-loading-indicator" class="hidden">‚è≥</span>
      </div>
    </div>
  </div>
  <!-- End Add Job Modal -->
</div>
{% endblock %}

<script>
  // Extend Alpine data for credit balance
  document.addEventListener('alpine:init', () => {
    Alpine.data('authFlow', () => ({
      isLoggedIn: false,
      userEmail: null,
      creditBalance: null, // Add credit balance state
      async init() {
        console.log('Auth flow initializing...');
        await this.configureAmplify();
        await this.checkAuthState();
        if (this.isLoggedIn) {
          await this.fetchUserData(); // Fetch user data including credits
        }
        // Handle redirect from Cognito
        if (window.location.hash.includes('id_token')) {
          console.log('Detected id_token in URL hash.');
          // Amplify handles token storage automatically on redirect
          // We might need a small delay or check if Amplify has processed it
          setTimeout(async () => {
            console.log('Re-checking auth state after potential redirect...');
            await this.checkAuthState();
            if (this.isLoggedIn) {
              await this.fetchUserData();
              window.location.hash = ''; // Clear the hash
            }
          }, 1500); // Adjust delay if needed
        }
        // Add event listener for successful login
        window.addEventListener('loginSuccess', async () => {
            console.log('Login success event received, fetching user data...');
            await this.fetchUserData();
        });
        // Add event listener for logout
        window.addEventListener('logoutSuccess', () => {
            console.log('Logout success event received, clearing user data...');
            this.isLoggedIn = false;
            this.userEmail = null;
            this.creditBalance = null; // Clear credits on logout
            localStorage.removeItem('id_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.currentUserId = null; // Clear global user ID
        });
      },
      async configureAmplify() {
        // ... (existing configureAmplify code)
        if (window.COGNITO_USER_POOL_ID && window.COGNITO_APP_CLIENT_ID && window.AWS_REGION) {
            console.log('Configuring Amplify Auth...');
            Amplify.configure({
                Auth: {
                    region: window.AWS_REGION,
                    userPoolId: window.COGNITO_USER_POOL_ID,
                    userPoolWebClientId: window.COGNITO_APP_CLIENT_ID,
                    oauth: {
                        domain: window.COGNITO_DOMAIN.replace('https://', ''), // Remove https://
                        scope: ['email', 'openid', 'profile'],
                        redirectSignIn: window.location.origin,
                        redirectSignOut: window.location.origin,
                        responseType: 'token' // Use 'token' for Implicit Grant (id_token in hash)
                    }
                }
            });
            console.log('Amplify Auth configured.');
        } else {
            console.log('Cognito environment variables not set. Amplify Auth not configured.');
        }
      },
      async checkAuthState() {
        // ... (existing checkAuthState code)
        try {
            const session = await Auth.currentSession();
            console.log('User is authenticated:', session);
            this.isLoggedIn = true;
            const idToken = session.getIdToken().getJwtToken();
            const accessToken = session.getAccessToken().getJwtToken();
            const refreshToken = session.getRefreshToken().getToken();
            localStorage.setItem('id_token', idToken);
            localStorage.setItem('access_token', accessToken);
            localStorage.setItem('refresh_token', refreshToken);
            window.dispatchEvent(new CustomEvent('loginSuccess'));

        } catch (error) {
            console.log('User is not authenticated:', error);
            this.isLoggedIn = false;
            window.dispatchEvent(new CustomEvent('logoutSuccess'));
        }
      },
      async fetchUserData() {
          console.log('Fetching user data from /users/me...');
          if (!this.isLoggedIn) return;
          try {
              const response = await fetch('/users/me', { headers: window.authHeaders() });
              if (!response.ok) {
                  throw new Error(`Failed to fetch user data: ${response.statusText}`);
              }
              const userData = await response.json();
              console.log('User data received:', userData);
              this.userEmail = userData.email;
              this.creditBalance = userData.credits;
              window.currentUserId = userData.id; // Set global user ID if still needed elsewhere
              // Ensure SSE connects after user ID is known
              if (window.connectSSE) {
                window.connectSSE(userData.id);
              }

          } catch (error) {
              console.error('Error fetching user data:', error);
              // Handle error, maybe logout user
              this.handleLogout();
          }
      },
      handleLogin() {
        // ... (existing handleLogin code)
        Auth.federatedSignIn();
      },
      async handleLogout() {
        // ... (existing handleLogout code)
        try {
            await Auth.signOut();
            console.log('User signed out successfully.');
            window.dispatchEvent(new CustomEvent('logoutSuccess'));
        } catch (error) {
            console.error('Error signing out: ', error);
        }
      },
      // --- Buy Credits Logic --- //
      async buyCredits() {
          if (!this.isLoggedIn) {
              console.warn('User not logged in, cannot buy credits.');
              return;
          }
          console.log('Attempting to buy credits...');
          try {
              const response = await fetch('/billing/checkout-session', {
                  method: 'POST',
                  headers: window.authHeaders()
              });
              if (!response.ok) {
                   const errorData = await response.json();
                   throw new Error(errorData.detail || 'Failed to create Stripe checkout session');
              }
              const session = await response.json();
              console.log('Stripe session created:', session);
              if (session.url) {
                  window.location.href = session.url; // Redirect to Stripe Checkout
              }
          } catch (error) {
              console.error('Error buying credits:', error);
              // Show error to user (e.g., using toast)
              if (window.showToast) {
                  window.showToast(`Error: ${error.message}`, 'error');
              }
          }
      }
    }))
  });
</script>
